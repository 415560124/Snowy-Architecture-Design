### 飞行计划审核审批业务技术选型调研


#### 1. 业务需求分析

首先，根据核心业务场景：飞行计划审核审批

**审核功能**：平台内内置审核单位或按照飞行计划区域审核，会出现多单位同时审核或顺序审核的功能。 

**审批功能**：上报给上级平台，等待上级审批结果；或有可能存在多个步骤先上传资质文件等待审批结果，通过后再上传申报文件等待审批结果功能。 还有可能关闭审核功能，直接申报到上级平台。

- **核心业务流**: 飞行计划的审核与审批。
- **审核功能 (平台内处理)**:
  - **审核单位**: 内置审核单位 或 按飞行计划区域动态确定审核单位。
  - **审核模式**:
    - **并行审核**: 多个单位同时对同一份计划进行审核。
    - **顺序审核**: 多个单位按预定顺序依次审核。
  - **灵活性**: 审核单位的组合和顺序可能根据计划类型、区域、风险等级等因素动态变化。
- **审批功能 (跨平台处理)**:
  - **上报上级**: 将计划上报给上级平台，等待其审批结果。
  - **多步骤审批**: 可能存在多阶段上报，例如：
    1. 先上传资质文件，等待审批。
    2. 资质审批通过后，再上传申报文件，等待最终审批。
- **特殊流程**:
  - **跳过审核**: 系统需要支持关闭审核功能，直接将计划申报到上级平台。

**核心挑战**:

1. **流程的动态性**: 审核单位的组成和顺序不是固定的，需要根据业务规则动态生成。
2. **流程的混合性**: 流程中既有**同步执行**的逻辑（如获取审核单位、跳过审核流程），也有**异步等待**的任务（如等待审核单位结果、上送上级审批）。
3. **规则的复杂性**: 决定审核单位、审核顺序、是否需要审核等，是一套复杂的业务规则。
4. **流程的可视化与管理**: 需要对流程的执行状态进行跟踪、管理和干预。

------

#### 2. 候选技术方案分析

##### 2.1 LiteFlow：轻量级规则引擎

- **核心定位**: 专注于**逻辑编排**和**动态规则执行**。它将业务逻辑拆分成一个个独立的组件（`Node`），然后通过规则文件（如 XML、EL 表达式）来定义这些组件的执行顺序和条件。
- **核心优势**:
  - **极致灵活**: 非常适合处理动态、复杂的业务规则。审核单位的动态组合和顺序可以轻松通过规则文件来配置，无需修改代码。
  - **高性能**: 设计轻量，执行效率高。
  - **开发便捷**: 学习曲线相对平缓，易于集成。
- **核心劣势**:
  - **流程管理弱**: 不是一个传统意义上的工作流引擎，缺乏对 **任务（Task）** 的概念。它无法很好地管理 “某个单位待审核” 这样的任务状态，也没有内置的任务分配、签收、驳回等功能。
  - **可视化缺失**: 没有标准的流程定义可视化工具（如 BPMN 编辑器），流程逻辑主要体现在规则文件中，对于非技术人员（如业务分析师）不够友好。
  - **状态持久化**: 需要自行设计和实现流程实例的状态持久化方案，以支持长时间运行的流程（如等待单位审核、上级审批）。

##### 2.2 Activiti：成熟的工作流引擎

- **核心定位**: 专注于**流程自动化**和**任务管理**。它遵循 BPMN 2.0 标准，通过图形化的方式定义流程，并内置了强大的任务管理、角色分配和流程实例跟踪功能。
- **核心优势**:
  - **强大的流程建模**: BPMN 标准提供了丰富的流程元素（如用户任务、服务任务、并行网关、排他网关等），能很好地建模串行、并行、分支等复杂流程。
  - **完善的任务生命周期管理**: 天然支持任务的创建、分配、签收、完成、驳回等，非常适合处理 “审核” 这类需要人参与的任务。
  - **可视化与监控**: 提供流程设计器和管理控制台，可以直观地查看和管理流程定义与实例。
  - **健壮与成熟**: 作为一个老牌工作流引擎，在各种复杂的企业级应用中得到了广泛验证。
- **核心劣势**:
  - **规则处理能力相对弱**: 虽然可以通过网关条件（Expression）来实现分支，但对于 “根据计划区域动态获取 N 个审核单位并进行并行审核” 这类高度动态的规则，用纯 BPMN 建模会非常繁琐和不灵活，通常需要在 Java 代码中实现，破坏了流程的纯粹性。
  - **重量感**: 功能强大意味着配置和学习成本相对较高。

------

#### 3. 技术选型与方案设计

基于业务需求和技术特性，来分析如何选择。

**方案一：仅使用 LiteFlow**

- **适用场景**: 如果审核审批流程非常简单，或者公司技术团队希望完全自主掌控所有流程逻辑。
- **优势**:
  - 开发灵活，迭代速度快。
  - 系统整体架构轻量。
- **风险与挑战**:
  - **任务管理是硬伤**: 需要从零开始构建一套任务分配、签收、通知、催办的系统。这相当于重新造一个简化版的工作流引擎。
  - **状态追踪困难**: 对于长时间运行的流程（如上送上级审批），需要自己设计数据库表结构来持久化流程状态，实现复杂。
  - **业务可读性差**: 业务人员无法直观地理解流程，流程变更需要开发人员修改规则文件。

**方案二：仅使用 Activiti**

- **适用场景**: 如果审核单位和审核顺序相对固定，或者可以通过有限的几种模式来覆盖大部分场景。
- **优势**:
  - 开箱即用的任务管理和流程可视化。
  - 成熟稳定，社区支持强大。
- **风险与挑战**:
  - **动态审核单位处理困难**: 当审核单位需要动态确定时，通常的做法是：
    1. 在流程启动前，通过 Java 代码计算出审核单位列表。
    2. 在 BPMN 模型中预先定义一个足够数量的并行网关和用户任务节点。
    3. 通过代码动态激活对应数量的任务节点，并分配给相应的单位。
  - 这种方式非常不优雅，扩展性差，且 BPMN 模型会变得臃肿不堪。
  - **规则与流程耦合**: 动态逻辑混入 Java 代码，使得流程定义不够纯粹，难以维护。

**方案三：Activiti + LiteFlow 组合使用**

- **核心理念**: **Activiti 负责 “宏观” 的流程骨架和任务生命周期管理，LiteFlow 负责 “微观” 的动态规则计算和逻辑编排。**
- **架构设计**:
  1. **Activiti 定义主流程**:
     - 使用 BPMN 设计整个飞行计划的主流程骨架。
     - 定义清晰的节点：如 “提交申请” -> “平台审核阶段” -> “上报上级审批” -> “审批完成”。
     - 对于需要多人参与的审核任务，使用 **“用户任务 (User Task)”**。
     - 对于需要调用外部系统或等待外部结果的，使用 **“服务任务 (Service Task)”** 或 **“接收任务 (Receive Task)”**。
  2. **LiteFlow 嵌入关键节点**:
     - 在 Activiti 的 “平台审核阶段” 这个节点中，不直接定义具体的审核人。
     - 而是通过一个 **“服务任务 (Service Task)”** 来调用 LiteFlow 的引擎。
     - LiteFlow 引擎根据当前飞行计划的上下文（区域、类型等），执行以下操作：
       - **规则计算**: 动态计算出需要参与审核的单位列表。
       - **逻辑编排**: 根据业务规则，决定是并行审核还是顺序审核。
       - **任务创建**: LiteFlow 执行完毕后，将计算出的审核单位列表返回给 Activiti。
     - Activiti 接收到列表后，通过其 API 动态创建多个并行的 **“用户任务”**，分配给相应的审核单位。
- **如何实现 “跳过审核”**:
  - 在 Activiti 的主流程开始处，设置一个**排他网关 (Exclusive Gateway)**。
  - 网关的条件判断逻辑（Expression）可以再次调用 LiteFlow。
  - LiteFlow 根据计划类型或其他规则，返回一个布尔值（`needReview`）。
  - Activiti 根据返回结果，决定流程是走向 “平台审核阶段” 还是直接走向 “上报上级审批”。
- **实现 “多步骤审批”**:
  - 在 BPMN 模型中，清晰地定义两个连续的 “上报审批” 服务任务节点即可。第一个节点上传资质文件并等待，完成后进入第二个节点上传申报文件并等待。

**最终选择**:

**方案三：Activiti + LiteFlow 组合使用**。

- **Activiti** 提供了坚实的**流程骨架**和**任务管理**能力，保证了系统的健壮性和可管理性。
- **LiteFlow** 提供了强大的**动态规则计算**能力，保证了业务逻辑的灵活性和可扩展性。

这种分层解耦的设计，使得业务流程的结构性变更（如增加一个审批阶段）可以在 Activiti 的 BPMN 模型中轻松完成，而审核单位的规则变更（如增加一个新的审核区域）则可以在 LiteFlow 的规则文件中快速配置，两者互不干扰，极大地提升了系统的可维护性和未来的扩展能力。

### 飞行计划审核审批系统 - 方案三（Activiti + LiteFlow）设计与实现

#### 1. 整体架构设计

将系统分为三层：**表现层**、**业务逻辑层**和**数据持久层**。Activiti 和 LiteFlow 都位于业务逻辑层。

- **表现层 (UI/API)**:
  - 用户界面：供用户提交飞行计划、查看审核状态、处理待办审核任务。
  - API 接口：供前端调用，触发流程、提交任务、查询状态。
- **业务逻辑层 (Service Layer)**:
  - **流程编排引擎 (Activiti)**:
    - **职责**: 管理宏观流程。定义流程的起点、终点、主要阶段和任务节点。负责流程的 “骨架” 和任务的生命周期。
    - **核心对象**: `ProcessEngine`, `RuntimeService`, `TaskService`, `RepositoryService`。
  - **规则引擎 (LiteFlow)**:
    - **职责**: 执行动态逻辑。在流程的关键节点，被 Activiti 调用，负责计算，即根据业务规则动态决定下一步。
    - **核心对象**: `FlowExecutor`, 组件 (`Node`), 规则文件 (`flow.xml`)。
  - **业务服务 (Business Service)**:
    - **职责**: 处理具体的业务操作，如保存飞行计划数据、调用外部接口上报审批等。它是 Activiti 和 LiteFlow 都可以调用的原子服务。
- **数据持久层 (Data Layer)**:
  - **Activiti 数据库**: Activiti 自带的一套表结构，用于存储流程定义、流程实例、任务、变量等。

**架构交互图**:

```plaintext
┌───────────────┐
│   表现层       │  (用户/前端)
│  UI / API     │
└───────┬───────┘
        ▼
┌─────────────────────────────────────────────┐
│           业务逻辑层                          │
│  ┌─────────────┐      ┌─────────────────┐   │
│  │  Activiti   │      │   LiteFlow      │   │
│  │ (工作流引擎)  │◄────►│ (规则引擎)       │   │
│  └───────┬─────┘      └────────┬────────┘   │
│          │                     │             │
│          ▼                     ▼             │
│  ┌─────────────────────────────────────────┐ │
│  │       业务服务 (Business Service)        │ │
│  └─────────────────────────────────────────┘ │
└─────────────────────────────────────────────┘
        ▲
        │
┌───────┴───────┐
│   数据层       │
│  (DB, Cache)  │
└───────────────┘
```

#### 2. Activiti 流程设计 (BPMN 模型)

使用 BPMN 2.0 来定义主流程。以下是一个简化的流程定义 (`flightPlanProcess.bpmn20.xml`)：

```xml
<?xml version="1.0" encoding="UTF-8"?>
<bpmn2:definitions ... id="Definitions_1" targetNamespace="http://activiti.org/bpmn">
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <!-- ... 图形化定义 ... -->
  </bpmndi:BPMNDiagram>
  <bpmn2:process id="flightPlanProcess" isExecutable="true">
    <!-- 1. 开始事件 -->
    <bpmn2:startEvent id="StartEvent_1" />
    <bpmn2:sequenceFlow id="Flow_1" sourceRef="StartEvent_1" targetRef="Gateway_NeedReview" />

    <!-- 2. 判断是否需要审核 (排他网关) -->
    <bpmn2:exclusiveGateway id="Gateway_NeedReview" default="Flow_SkipReview" />
    
    <!-- 2a. 需要审核的路径 -->
    <bpmn2:sequenceFlow id="Flow_NeedReview" sourceRef="Gateway_NeedReview" targetRef="ServiceTask_GetReviewers">
      <bpmn2:conditionExpression xsi:type="bpmn2:tFormalExpression">${needReview == true}</bpmn2:conditionExpression>
    </bpmn2:sequenceFlow>

    <!-- 3. 调用 LiteFlow 获取审核单位列表 (服务任务) -->
    <bpmn2:serviceTask id="ServiceTask_GetReviewers" name="获取审核单位"
                       activiti:delegateExpression="${getReviewersDelegate}" />
    <bpmn2:sequenceFlow id="Flow_2" sourceRef="ServiceTask_GetReviewers" targetRef="UserTask_Review" />

    <!-- 4. 审核任务 (多实例任务) -->
    <bpmn2:userTask id="UserTask_Review" name="平台审核"
                    activiti:candidateUsers="${reviewers}"
                    activiti:assignee="${reviewer}">
      <!-- 多实例配置 elementVariable为循环集合的变量名-->
      <bpmn2:multiInstanceLoopCharacteristics isSequential="false" activiti:collection="${reviewUnitsList}" activiti:elementVariable="reviewUnit">
         <!-- nrOfInstances 实例总数 ，nrOfActiveInstances 当前还没有完成的实例 , nrOfCompleteInstances 已经完成的实例个数 -->
        <bpmn2:completionCondition>${nrOfCompletedInstances >= nrOfInstances}</bpmn2:completionCondition>
      </bpmn2:multiInstanceLoopCharacteristics>
    </bpmn2:userTask>
    <bpmn2:sequenceFlow id="Flow_3" sourceRef="UserTask_Review" targetRef="ServiceTask_SubmitApproval" />

    <!-- 2b. 跳过审核的路径 -->
    <bpmn2:sequenceFlow id="Flow_SkipReview" sourceRef="Gateway_NeedReview" targetRef="ServiceTask_SubmitApproval" />

    <!-- 5. 上报上级审批 (服务任务) -->
    <bpmn2:serviceTask id="ServiceTask_SubmitApproval" name="上报上级审批"
                       activiti:delegateExpression="${submitApprovalDelegate}" />
    <bpmn2:sequenceFlow id="Flow_4" sourceRef="ServiceTask_SubmitApproval" targetRef="EndEvent_1" />

    <!-- 6. 结束事件(继续扩展) -->
    <bpmn2:endEvent id="EndEvent_1" />
  </bpmn2:process>
</bpmn2:definitions>
```

**BPMN 关键节点说明**:

- **`Gateway_NeedReview` (排他网关)**: 判断是否需要审核。`needReview` 变量的值可以在流程启动时传入，或通过一个前置的服务任务计算得出。
- **`ServiceTask_GetReviewers` (服务任务)**: 这是与 LiteFlow 集成的关键点。
  - `activiti:delegateExpression="${getReviewersDelegate}"` 指定了一个 Java Delegate Bean。
  - 这个 Delegate 的 `execute` 方法会调用 LiteFlow 引擎。
- **`UserTask_Review` (用户任务)**:
  - **多实例 (`multiInstanceLoopCharacteristics`)**: `isSequential="false"` 表示并行审核。`activiti:collection="${reviewUnitsList}"` 会从流程变量中获取一个列表（如 `["unit1", "unit2"]`），并为列表中的每一项创建一个任务实例。
  - `completionCondition` 定义了多实例任务何时完成。`${nrOfCompletedInstances >= nrOfInstances}` 表示所有审核单位都完成后，该节点才算通过。

#### 4. LiteFlow 规则与组件设计

LiteFlow 负责实现 `ServiceTask_GetReviewers` 中调用的动态逻辑。

**步骤 1: 定义 LiteFlow 组件 (Java Code)**

```java
// 获取审核单位列表的组件
@Component("getReviewUnits")
public class GetReviewUnitsNode extends NodeComponent {
    @Autowired
    private ReviewUnitService reviewUnitService;

    @Override
    public void process() {
        // 1. 从流程上下文获取参数
        FlightPlanContext context = this.getFirstContextBean();
        String flightArea = context.getFlightArea();
        String flightType = context.getFlightType();

        // 2. 执行业务逻辑，从数据库或规则引擎获取审核单位
        List<String> reviewUnitIds = reviewUnitService.findReviewUnitsByAreaAndType(flightArea, flightType);

        // 3. 将结果放入上下文，供后续节点使用
        context.setReviewUnitIds(reviewUnitIds);
    }
}
```

**步骤 2: 定义 LiteFlow 规则 (`flow.xml`)**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<flow>
    <!-- 定义一个流程，用于获取审核单位 -->
    <chain name="getReviewersChain">
        THEN(getReviewUnits);
    </chain>
</flow>
```

这个例子很简单，如果逻辑更复杂（例如，先根据区域筛选，再根据任务类型过滤），可以用 `THEN`, `WHEN` 等关键字编排多个组件。

#### 5. Activiti 与 LiteFlow 集成实现

**步骤 1: 实现 Java Delegate**，获取审核单位

```java
@Component("getReviewersDelegate")
public class GetReviewersDelegate implements JavaDelegate {

    @Autowired
    private FlowExecutor flowExecutor;

    @Override
    public void execute(DelegateExecution execution) {
        // 1. 从 Activiti 获取业务数据
        String planId = execution.getProcessBusinessKey();
        FlightPlan plan = flightPlanService.getById(planId);

        // 2. 准备 LiteFlow 的上下文
        LiteflowResponse response = flowExecutor.execute2Resp("getReviewersChain", plan);

        // 3. 从 LiteFlow 结果中获取数据
        if (response.isSuccess()) {
            FlightPlanContext context = response.getFirstContextBean();
            List<String> reviewUnitIds = context.getReviewUnitIds();

            // 4. 将结果设置回 Activiti 的流程变量中
            // 注意：多实例任务需要一个列表变量
            execution.setVariable("reviewUnitsList", reviewUnitIds);
            
            // 也可以直接设置候选人
            // execution.setVariable("reviewers", String.join(",", reviewUnitIds));
        } else {
            // 处理异常
            throw new BpmnError("LITEFLOW_ERROR", "获取审核单位失败: " + response.getMessage());
        }
    }
}
```

**步骤 2: 启动流程**

业务服务中，当用户提交飞行计划时，启动 Activiti 流程。

```java
@Service
public class FlightPlanServiceImpl implements FlightPlanService {
    @Autowired
    private RuntimeService runtimeService;

    public void submitFlightPlan(FlightPlan plan) {
        // 保存飞行计划数据
        this.save(plan);

        // 设置流程变量
        Map<String, Object> variables = new HashMap<>();
        variables.put("needReview", true); // 或者根据规则动态判断

        // 启动流程实例，businessKey 关联业务数据
        runtimeService.startProcessInstanceByKey("flightPlanProcess", plan.getId(), variables);
    }
}
```

**步骤 3: 处理用户任务**

当 Activiti 流程到达 `UserTask_Review` 节点时，会创建任务。前端通过 `TaskService` 查询待办任务。用户完成审核后，调用 `taskService.complete(taskId, variables)` 来完成任务并推进流程。

### 总结与流程示例

1. **用户提交**: 用户在 UI 上提交飞行计划，保存数据并调用启动 Activiti 流程。
2. **Activiti 流转**: 流程到达 `ServiceTask_GetReviewers`。
3. **Delegate 调用 LiteFlow**: `GetReviewersDelegate` 的 `execute` 方法被触发，它调用 LiteFlow 的 `getReviewersChain`。
4. **LiteFlow 执行**: `GetReviewUnitsNode` 根据飞行计划区域和类型，从数据库查询出需要审核的单位列表（如 `["unit-A-id", "unit-B-id"]`）。
5. **结果返回 Activiti**: LiteFlow 将列表返回给 Delegate，Delegate 通过 `execution.setVariable("reviewUnitsList", ...)` 将其设置为流程变量。
6. **创建审核任务**: Activiti 进入 `UserTask_Review` 多实例节点。它发现 `reviewUnitsList` 变量，于是为 "unit-A-id" 和 "unit-B-id" 各创建一个待办审核任务。
7. **用户审核**: 审核员 A 和 B 登录系统，看到各自的待办任务，填写意见并提交。
8. **流程继续**: 当最后一个审核员（比如 B）完成任务后，`completionCondition` 满足，`UserTask_Review` 节点结束。
9. **上报审批**: 流程流转到 `ServiceTask_SubmitApproval`，调用相应的 Delegate 将计划上报给上级平台。
10. **流程结束**: 上报完成后，流程到达 `EndEvent`，整个飞行计划审核审批流程结束。